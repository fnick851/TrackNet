<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TrackNet: Bubbles View</title>
<script type="text/javascript" src="../lib/d3.min.js"></script>
<script type="text/javascript" src="../lib/d3-transform.js"></script>
<script type="text/javascript" src="../lib/jquery-2.1.3.min.js"></script>
<style>
text {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  pointer-events: none;
}
.catgoryBubble text {
  text-anchor: middle;
  fill: white;
}
.trackerButton,
.p1Item {
  font-size: 12px;
}
.trackerButton,
.catgoryBubble {
  cursor: pointer;
}
</style>
</head>
<body>
	<script type="text/javascript">
		var colors = d3.scale.category10();
		var svg = d3.select("body")
		            .append("svg")
		            .attr("width", 1500)
		            .attr("height", 1000);
		
		var completeData;
		var domainId;
		
		var p1Info;
		var bubbleData = [];
		var bubbleCenter = [300,300];
		var bigRadius = 120;
		var smallRadius = 60;
		var bubbleSizeRange = [20, 60];
		var bubbleScale;
		var shrinkRadius = 20;
		var rightMostAngle = 0;
		
		var boxTopLeft = [600,60];
		var boxDimentions = [250,420];
		var boxVisibleCapacity = 16;
		var trackerItemHeight = 20;
		
		var p1ListTopLeft = [900,60];
		var p1ListItemDimentions = [180,20];
		var p1ListVisibleCapacity = 16;
		
		d3.json("data/851.adjacency.json", function(error, root) {
			completeData = root;
			domainId = 1004;
			p1Info = root.firstPartyDomains[domainId];
			for (var i = 0; i < p1Info.catList.length; i++) {
				bubbleData.push({ "index": i,
								  "id": p1Info.catList[i],
								  "category": root.catList[p1Info.catList[i]],
								  "size": p1Info[p1Info.catList[i]].length });
			}
			drawGraph();
		});
		
		function computeBubblePositions() {
			var bigBubbleIdx = [-1,-1];
			var smallBubbleIdx = [-1,-1];
			var sizeRange = [-1,-1];
			for (var i = 0; i < bubbleData.length; i++) {
				if (bubbleData[i].shrink != true) {
					if (sizeRange[1] < 0) {
						sizeRange[1] = bubbleData[i].size;
					}
					sizeRange[0] = bubbleData[i].size;
				}
			}
			bubbleScale = d3.scale.sqrt()
							.domain(sizeRange)
							.range(bubbleSizeRange);
			for (var i = 0; i < bubbleData.length; i++) {
				if (bubbleData[i].shrink != true) {
					bubbleData[i].R = bigRadius;
					bubbleData[i].r = bubbleScale(bubbleData[i].size);
					bigBubbleIdx = computeAngle(i, bigBubbleIdx[0], bigBubbleIdx[1]);
				} else {
					bubbleData[i].R = smallRadius;
					bubbleData[i].r = shrinkRadius;
					smallBubbleIdx = computeAngle(i, smallBubbleIdx[0], smallBubbleIdx[1]);
				}
			}
		}
		
		function computeAngle(i, preIdx, firstIdx) {
			if (firstIdx < 0) {
				bubbleData[i].angle = 0;
				return [i,i];
			} else {
				var angle = bubbleAngle(bubbleData[i].R, bubbleData[preIdx].r, bubbleData[i].r);
				var angleCC = bubbleAngle(bubbleData[i].R, bubbleData[firstIdx].r, bubbleData[i].r);
				if (angle + bubbleData[preIdx].angle <= 2 * Math.PI - angleCC) {
					bubbleData[i].angle = angle + bubbleData[preIdx].angle;
					preIdx = i;
				} else {
					bubbleData[i].angle = bubbleData[preIdx].angle;
				}
				return [preIdx,firstIdx];	
			}
		}
		
		function bubbleAngle(R, r1, r2) {
			var a = r1 + r1/10 + r2;
			var b = R + r1;
			var c = R + r2;
			return Math.acos((Math.pow(b,2)+Math.pow(c,2)-Math.pow(a,2))/(2*b*c));
		}
		
		function bubbleX(data) {
			return bubbleCenter[0] + (data.R + data.r) * Math.cos(data.angle-rightMostAngle);
		}
		
		function bubbleY(data) {
			return bubbleCenter[1] + (data.R + data.r) * Math.sin(data.angle-rightMostAngle);
		}
		
		function shrinkTransition(token, data) {
			token.transition()
				 .attr("cx", bubbleX(data))
				 .attr("cy", bubbleY(data))
				 .attr("r", data.r)
				 .each("end", function() {
					 reDrawBubbles();
				 });
		}
		
		function reDrawBubbles() {
			computeBubblePositions();
			svg.selectAll(".catgoryBubble")
			   .data(bubbleData);
			drawBubbleText();
			return drawBubbles();
		}
		
		function drawTriangle(offset, rotate, index, visibility) {
			var dim = 20;
			if (rotate == 90 || rotate == 180) {
				offset[0] += dim;
			}
			if (rotate == 180 || rotate == 270) {
				offset[1] += dim;
			}
			var transform = d3.svg.transform()
							  .translate(offset)
							  .rotate(rotate);
			return d3.select("#trackersBox")
					 .append("polygon")
					 .attr("points", "0,0 "+dim+",0 "+dim/2+","+dim)
					 .attr("fill", colors(index))
					 .attr("visibility", visibility)
					 .attr("transform", transform)
					 .on("mouseover", function() {
						 d3.select(this).attr("opacity", 0.2);
					 })
					 .on("mouseout", function() {
						 d3.select(this).attr("opacity", null);
					 });
		}
		
		function drawCloseButton(x, y, r) {
			var rc = r/2;
			var closeButton = svg.append("g")
								 .attr("id", "closeButton")
								 .style("pointer-events", "none");
			closeButton.append("circle")
					   .attr("cx", x)
					   .attr("cy", y)
					   .attr("r", r)
					   .attr("fill", "white")
					   .attr("opacity", 0.7);
			closeButton.append("line")
					   .attr("x1", x-rc)
					   .attr("y1", y-rc)
					   .attr("x2", x+rc)
					   .attr("y2", y+rc)
					   .attr("stroke", "black")
					   .attr("stroke-width", rc/3);
			closeButton.append("line")
					   .attr("x1", x+rc)
					   .attr("y1", y-rc)
					   .attr("x2", x-rc)
					   .attr("y2", y+rc)
					   .attr("stroke", "black")
					   .attr("stroke-width", rc/3);
		}
		
		function drawTrackersBox(data) {
			var trackerButtons = drawTrackersList("trackersBox", data);

			var dim = trackerItemHeight * 0.5;
			trackerButtons.append("polygon")
						  .attr("points", "0,0 "+dim+",0 "+dim/2+","+dim)
						  .attr("fill", colors(data.index))
						  .attr("transform", function(d, i) {
							  return "translate("+(boxTopLeft[0]+boxDimentions[0]*0.86)+","
									  +(boxTopLeft[1]+85+trackerItemHeight*i)+") rotate(270)";
						  })
						  .style("pointer-events", "none")
						  .attr("opacity", 0.8);
			trackerButtons.on("mouseover", function() {
							   d3.select(this).select("rect")
							     .attr("fill", colors(data.index));
							   d3.select(this).select("text")
							     .attr("font-weight", "bold");
						   })
						   .on("mouseout", function() {
							   if (d3.select(this).attr("status") != "on") {
								   d3.select(this).select("rect")
								     .attr("fill", "white");
								   d3.select(this).select("text")
								     .attr("font-weight", null);
							   }
						   })
						   .on("click", function(data) {
							   svg.selectAll(".trackerButton[status=on] rect")
							      .attr("fill", "white");
							   svg.selectAll(".trackerButton[status=on] text")
							      .attr("font-weight", null);
							   svg.selectAll(".trackerButton[status=on]")
							      .attr("status", null);
							   d3.select(this).attr("status", "on");
							   d3.select("#p1List").remove();
							   drawP1List(data);
						   });
			
			var navOffset = 10;
			var triLeft = drawTriangle([boxTopLeft[0]+45,boxTopLeft[1]+navOffset], 90, data.index, null);
			triLeft.on("click", function() {
				d3.select("#trackersBox").remove();
				d3.select("#p1List").remove();
			});
			drawTriangle([boxTopLeft[0]+115,boxTopLeft[1]+navOffset], 0, data.index, "hidden");
			drawTriangle([boxTopLeft[0]+185,boxTopLeft[1]+navOffset], 270, data.index, null);
		}
		
		function drawTrackersList(className, data) {
			var token = svg.append("g").attr("id", className);
			
			token.append("rect")
				 .attr("x", boxTopLeft[0])
				 .attr("y", boxTopLeft[1])
				 .attr("rx", 40)
				 .attr("ry", 40)
				 .attr("width", boxDimentions[0])
				 .attr("height", boxDimentions[1])
				 .attr("fill", "white")
				 .attr("stroke", colors(data.index));
			
			token.append("text")
				 .attr("x", boxTopLeft[0]+boxDimentions[0]/2)
				 .attr("y", boxTopLeft[1]+55)
				 .attr("fill", colors(data.index))
				 .style("text-anchor", "middle")
				 .text(data.category);
			
			var boxData = [];
			for (var i = 0; i < boxVisibleCapacity && i < p1Info[data.id].length; i++) {
				var trackerId = p1Info[data.id][i];
				boxData.push({"id":trackerId,"domain":completeData.domainList[trackerId]});
			}
			
			var trackerButtons = token.selectAll("g")
									  .data(boxData)
									  .enter()
									  .append("g")
									  .attr("class", "trackerButton");
			trackerButtons.append("rect")
						  .attr("x", boxTopLeft[0] + boxDimentions[0] * 0.05)
						  .attr("y", function(d, i) {
							  return boxTopLeft[1]+70+trackerItemHeight*i;
						  })
						  .attr("rx", 5)
						  .attr("ry", 5)
						  .attr("width", boxDimentions[0] * 0.9)
						  .attr("height", trackerItemHeight)
						  .attr("fill", "white")
						  .attr("stroke", colors(data.index))
						  .attr("opacity", 0.15);
			trackerButtons.append("text")
						  .attr("x", boxTopLeft[0] + boxDimentions[0] * 0.1)
						  .attr("y", function(d, i) {
							  return boxTopLeft[1]+85+trackerItemHeight*i;
						  })
						  .text(function(d) {
							  return d.domain;
						  });
			trackerButtons.append("text")
						  .attr("x", boxTopLeft[0] + boxDimentions[0] * 0.83)
						  .attr("y", function(d, i) {
							  return boxTopLeft[1]+85+trackerItemHeight*i;
						  })
						  .style("text-anchor", "end")
						  .text(function(d) {
							  return "["+(completeData.thirdPartyDomains[d.id].domainList.length-1)+"]";
						  });
			
			return trackerButtons;
		}
		
		function drawP1List(data) {
			var p1List = svg.append("g")
							.attr("id", "p1List");
			p1List.append("text")
				  .attr("x", p1ListTopLeft[0]+p1ListItemDimentions[0]/2)
				  .attr("y", p1ListTopLeft[1]+55)
				  .attr("fill", "gray")
				  .style("text-anchor", "middle")
				  .text("First-party Domains");
			
			var p1ListData = [];
			var list = completeData.thirdPartyDomains[data.id].domainList;
			for (var i = 0; i < p1ListVisibleCapacity && i < list.length; i++) {
				var p1Id = list[i];
				if (domainId == p1Id)
					continue;
				p1ListData.push({"id":p1Id,"domain":completeData.domainList[p1Id]});
			}
			var p1Items = p1List.selectAll("g")
								.data(p1ListData)
								.enter()
								.append("g")
								.attr("class", "p1Item");
			p1Items.append("rect")
				   .attr("x", p1ListTopLeft[0])
				   .attr("y", function(d, i) {
					   return p1ListTopLeft[1]+70+p1ListItemDimentions[1]*i;
				   })
				   .attr("rx", 5)
				   .attr("ry", 5)
				   .attr("width", p1ListItemDimentions[0])
				   .attr("height", p1ListItemDimentions[1])
				   .attr("fill", "gray")
				   .attr("opacity", 0.15);
			p1Items.append("text")
				   .attr("x", p1ListTopLeft[0] + p1ListItemDimentions[0] * 0.1)
				   .attr("y", function(d, i) {
					   return p1ListTopLeft[1]+85+p1ListItemDimentions[1]*i;
				   })
				   .text(function(d) {
					   return d.domain;
				   });
		}
		
		function drawBubbles() {
			return svg.selectAll(".catgoryBubble")
				      .select("circle")
				      .transition()
				      .attr("cx", function(d) {
					      return bubbleX(d);
				      })
				      .attr("cy", function(d) {
					      return bubbleY(d);
				      })
				      .attr("r", function(d) {
					      return d.r;
				      });
		}
		
		function drawBubbleText() {
			svg.selectAll(".catgoryBubble")
			   .select("#bubbleText1")
			   .transition()
			   .attr("x", function(d) {
				   return bubbleX(d);
			   })
			   .attr("y", function(d) {
				   return bubbleY(d) - d.r * 0.1;
			   })
			   .attr("font-size", function(d) {
				   return d.r * 0.23;
			   })
			   .text(function(d) {
				   return d.category.substr(0,15);
			   })
			   .attr("visibility", function(d) {
				   return d.shrink ? "hidden" : null;
			   });
			svg.selectAll(".catgoryBubble")
			   .select("#bubbleText2")
			   .transition()
			   .attr("x", function(d) {
				   return bubbleX(d);
			   })
			   .attr("y", function(d) {
				   return bubbleY(d) + d.r * 0.3;
			   })
			   .attr("font-size", function(d) {
				   return d.r * 0.26;
			   })
			   .text(function(d) {
				   return d.size;
			   })
			   .attr("visibility", function(d) {
				   return d.shrink ? "hidden" : null;
			   });
		}
		
		function drawGraph() {
			// Draw the central bubble
			svg.append("circle")
			   .attr("cx", bubbleCenter[0])
			   .attr("cy", bubbleCenter[1])
			   .attr("r", 20)
			   .attr("fill", "gray");
			// Bubble events
			computeBubblePositions();
			svg.selectAll("g")
			   .data(bubbleData)
			   .enter()
			   .append("g")
			   .attr("class", "catgoryBubble")
			   .on("click", function(data) {
				   var circle = d3.select(this).select("circle");
				   if (data.shrink != true) {
					   if (d3.mouse(this)[1] > circle.attr("cy")-circle.attr("r")/2) {
						   // Move a bubble to the right-most position.
						   rightMostAngle = data.angle;
						   var toRightCount = 0;
						   var circles = reDrawBubbles();
						   circles.each("start", function() {
							   toRightCount++;
						   })
						   .each("end", function() {
							   if ( --toRightCount != 0 )
								   return;
							   // Show the trackers' box.
							   drawTrackersBox(data);
						   });
						   d3.select("#closeButton").remove();
						   d3.select("#categoryTooltip").remove();
						   d3.select("#trackersBox").remove();
						   d3.select("#p1List").remove();
					   } else {
						   // Shrink a bubble
						   data.shrink = bubbleData[data.index].shrink = true;
						   data.R = smallRadius;
						   data.r = shrinkRadius;
						   shrinkTransition(circle, data);
						   d3.select(this).selectAll(".bubbleText").attr("visibility", "hidden");
						   d3.select("#closeButton").remove();
						   d3.select("#categoryTooltip").remove();
						   d3.select("#trackersBox").remove();
						   d3.select("#p1List").remove();
					   }
				   } else {
					   // Expand a bubble
					   data.shrink = bubbleData[data.index].shrink = false;
					   data.R = bigRadius;
					   data.r = data.r;
					   shrinkTransition(circle, data);
					   d3.select("#trackersBox").remove();
					   d3.select("#p1List").remove();
				   }
			   })
			   .on("mouseover", function(data) {
				   var circle = d3.select(this).select("circle");
				   if (data.shrink != true) {
					   // Display a close button
					   var x = Number(circle.attr("cx"));
					   var y = circle.attr("cy")-circle.attr("r")*3/4;
					   var r = circle.attr("r")/4;
					   drawCloseButton(x, y, r);
				   }
				   // Display a tooltip
				   drawTrackersList("categoryTooltip", data);
			   })
			   .on("mouseout", function() {
				   d3.select("#closeButton").remove();
				   d3.select("#categoryTooltip").remove();
			   });
			// Initial the bubbles
			svg.selectAll(".catgoryBubble")
			   .append("circle")
			   .attr("fill", function(d, i) {
				   return colors(i);
			   })
			   .attr("opacity", 0.9);
			drawBubbles()
			svg.selectAll(".catgoryBubble")
			   .append("text")
			   .attr("class", "bubbleText")
			   .attr("id", "bubbleText1");
			svg.selectAll(".catgoryBubble")
			   .append("text")
			   .attr("class", "bubbleText")
			   .attr("id", "bubbleText2");
			drawBubbleText();
		}
	</script>
</body>
</html>